# День 02 - Piscine SQL

## _Глубокое погружение в JOIN в SQL_

Резюме: Сегодня вы узнаете, как получать нужные данные на основе различных видов JOIN.

## Содержание

1. [Глава I](#глава-i) \
    1.1. [Вступление](#вступление)
2. [Глава II](#глава-ii) \
    2.1. [Общие правила](#общие-правила)
3. [Глава III](#глава-iii) \
    3.1. [Правила дня](#правила-дня)  
4. [Глава IV](#глава-iv) \
    4.1. [Упражнение 00 - Влево, вправо](#упражнение-00-влево-вправо)  
5. [Глава V](#глава-v) \
    5.1. [Упражнение 01 - Найти пропуски в данных](#упражнение-01-найти-пропуски-в-данных)  
6. [Глава VI](#глава-vi) \
    6.1. [Упражнение 02 - FULL значит «полностью заполнено»](#упражнение-02-full-значит-полностью-заполнено)  
7. [Глава VII](#глава-vii) \
    7.1. [Упражнение 03 - Переформатировать в CTE](#упражнение-03-переформатировать-в-cte)  
8. [Глава VIII](#глава-viii) \
    8.1. [Упражнение 04 - Найти любимые пиццы](#упражнение-04-найти-любимые-пиццы)
9. [Глава IX](#глава-ix) \
    9.1. [Упражнение 05 - Исследовать данные о людях](#упражнение-05-исследовать-данные-о-людях)
10. [Глава X](#глава-x) \
    10.1. [Упражнение 06 - Любимые пиццы Дениса и Анны](#упражнение-06-любимые-пиццы-дениса-и-анны)
11. [Глава XI](#глава-xi) \
    11.1. [Упражнение 07 - Самая дешевая пиццерия для Дмитрия](#упражнение-07-самая-дешевая-пиццерия-для-дмитрия)
12. [Глава XII](#глава-xii) \
    12.1. [Упражнение 08 - Продолжаем исследовать данные](#упражнение-08-продолжаем-исследовать-данные)
13. [Глава XIII](#глава-xiii) \
    13.1. [Упражнение 09 - Кто любит сыр и пепперони?](#упражнение-09-кто-любит-сыр-и-пепперони)
14. [Глава XIV](#глава-xiv) \
    14.1. [Упражнение 10 - Найти людей из одного города](#упражнение-10-найти-людей-из-одного-города)


## Глава I
## Вступление

![D02_01](misc/images/D02_01.png)

На картинке изображено реляционное выражение в виде дерева. Это выражение соответствует следующему SQL-запросу:

    SELECT *
        FROM R CROSS JOIN S
    WHERE clause

Другими словами, любой SQL-запрос можно описать математическими терминами реляционной алгебры.

Главный вопрос (который я слышу от студентов): зачем изучать реляционную алгебру, если можно сразу писать SQL? Мой ответ — и да, и нет. «Да» — вы можете написать SQL с первого раза, это верно. «Нет» — нужно знать основы реляционной алгебры, так как эти знания используются для оптимизации запросов и для семантических запросов.
Какие типы соединений существуют в реляционной алгебре?
На самом деле, «Cross Join» — это примитивный оператор и прародитель других видов соединений:
- Natural Join
- Theta Join
- Semi Join
- Anti Join
- Left / Right / Full Joins

Но что значит операция соединения двух таблиц? Вот псевдокод, как работает join без индексов:

    FOR r in R LOOP
        FOR s in S LOOP
        if r.id = s.r_id then add(r,s)
        …
        END;
    END;

Это просто набор циклов... Никакой магии!


## Глава II
## Общие правила

- Используйте эту страницу как единственный источник информации. Не слушайте слухи и домыслы о том, как выполнять задания.
- Убедитесь, что используете последнюю версию PostgreSQL.
- Можно использовать IDE для написания SQL-скриптов.
- Для проверки решения оно должно быть в вашем GIT-репозитории.
- Ваши решения будут проверяться вашими сокурсниками.
- Не оставляйте в директории никаких файлов, кроме явно указанных в условиях задания. Рекомендуется настроить `.gitignore` для предотвращения случайных ошибок.
- Есть вопрос? Спросите соседа справа. Если не помог — попробуйте слева.
- Ваши справочники: сокурсники / Интернет / Google.
- Внимательно читайте примеры. В них могут быть требования, не указанные явно в задании.
- Да пребудет с вами SQL-Сила!
- Абсолютно всё можно выразить на SQL! Начнем и получим удовольствие!

## Глава III
## Правила дня

- Убедитесь, что у вас есть собственная база данных и доступ к ней на вашем кластере PostgreSQL.
- Скачайте [скрипт](materials/model.sql) с моделью базы данных и примените его к своей базе (можно через psql или любую IDE, например DataGrip от JetBrains или pgAdmin от сообщества PostgreSQL).
- Все задания содержат разделы Allowed и Denied с перечислением разрешённых и запрещённых опций, типов данных, SQL-конструкций и т.д. Ознакомьтесь с ними перед началом.
- Посмотрите на логическую схему нашей базы данных.

![schema](misc/images/schema.png)

1. **pizzeria** — справочник доступных пиццерий
- id — первичный ключ
- name — название пиццерии
- rating — средний рейтинг (от 0 до 5)
2. **person** — справочник любителей пиццы
- id — первичный ключ
- name — имя
- age — возраст
- gender — пол
- address — адрес
3. **menu** — справочник меню и цен на конкретную пиццу
- id — первичный ключ
- pizzeria_id — внешний ключ на пиццерию
- pizza_name — название пиццы
- price — цена
4. **person_visits** — информация о посещениях пиццерий
- id — первичный ключ
- person_id — внешний ключ на person
- pizzeria_id — внешний ключ на pizzeria
- visit_date — дата посещения (например, 2022-01-01)
5. **person_order** — информация о заказах
- id — первичный ключ
- person_id — внешний ключ на person
- menu_id — внешний ключ на menu
- order_date — дата заказа (например, 2022-01-01)

Посещение и заказ — разные сущности и не связаны напрямую. Например, клиент может быть в одной пиццерии (просто смотрит меню), а заказать — в другой по телефону или через приложение. Или вообще заказать из дома.

## Глава IV
## Упражнение 00 - Влево, вправо

| Упражнение 00: Влево, вправо |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex00                                                                                                                     |
| Файлы для сдачи                       | `day02_ex00.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| SQL-конструкции                        | `NOT IN`, `IN`, `NOT EXISTS`, `EXISTS`, `UNION`, `EXCEPT`, `INTERSECT`                                                                                              |

Напишите SQL-запрос, который вернет список названий пиццерий с их рейтингом, которые не были посещены ни одним человеком.

## Глава V
## Упражнение 01 - Найти пропуски в данных

| Упражнение 01: Найти пропуски в данных|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex01                                                                                                                     |
| Файлы для сдачи                       | `day02_ex01.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| SQL-конструкции                        | `generate_series(...)`                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| SQL-конструкции                        | `NOT IN`, `IN`, `NOT EXISTS`, `EXISTS`, `UNION`, `EXCEPT`, `INTERSECT`                                                                                              |

Напишите SQL-запрос, который вернет пропущенные дни с 1 по 10 января 2022 года (включительно) для посещений людей с id 1 или 2 (то есть дни, которые пропустили оба). Отсортируйте результат по дате по возрастанию. Пример вывода:

| missing_date |
| ------ |
| 2022-01-03 |
| 2022-01-04 |
| 2022-01-05 |
| ... |

## Глава VI
## Упражнение 02 - FULL значит «полностью заполнено»

| Упражнение 02: FULL значит «полностью заполнено»|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex02                                                                                                                     |
| Файлы для сдачи                       | `day02_ex02.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| SQL-конструкции                        | `NOT IN`, `IN`, `NOT EXISTS`, `EXISTS`, `UNION`, `EXCEPT`, `INTERSECT`                                                                                              |

Напишите SQL-запрос, который вернет полный список имен людей, посещавших (или не посещавших) пиццерии с 1 по 3 января 2022 года, и полный список названий пиццерий, которые были посещены (или не посещены). В качестве значения для `NULL` в столбцах `person_name` и `pizzeria_name` используйте ‘-’. Отсортируйте результат по всем 3 столбцам.

| person_name | visit_date | pizzeria_name |
| ------ | ------ | ------ |
| - | null | DinoPizza |
| - | null | DoDo Pizza |
| Andrey | 2022-01-01 | Dominos |
| Andrey | 2022-01-02 | Pizza Hut |
| Anna | 2022-01-01 | Pizza Hut |
| Denis | null | - |
| Dmitriy | null | - |
| ... | ... | ... |

## Глава VII
## Упражнение 03 - Переформатировать в CTE

| Упражнение 03: Переформатировать в CTE |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex03                                                                                                                     |
| Файлы для сдачи                       | `day02_ex03.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |
| SQL-конструкции                        | `generate_series(...)`                                                                                              |
| **Запрещено**                               |                                                                                                                          |
| SQL-конструкции                        | `NOT IN`, `IN`, `NOT EXISTS`, `EXISTS`, `UNION`, `EXCEPT`, `INTERSECT`                                                                                              |

Вернитесь к упражнению 01 и перепишите ваш SQL, используя CTE (Common Table Expression). Вынесите генератор дат в CTE. Результат должен быть аналогичен упражнению 01.

| missing_date | 
| ------ | 
| 2022-01-03 | 
| 2022-01-04 | 
| 2022-01-05 | 
| ... |

## Глава VIII
## Упражнение 04 - Найти любимые пиццы

| Упражнение 04: Найти любимые пиццы |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex04                                                                                                                     |
| Файлы для сдачи                       | `day02_ex04.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Найдите всю информацию о возможных названиях пиццерий и ценах на грибную или пепперони пиццу. Отсортируйте результат по названию пиццы и пиццерии. Пример вывода:

| pizza_name | pizzeria_name | price |
| ------ | ------ | ------ |
| mushroom pizza | Dominos | 1100 |
| mushroom pizza | Papa Johns | 950 |
| pepperoni pizza | Best Pizza | 800 |
| ... | ... | ... |

## Глава IX
## Упражнение 05 - Исследовать данные о людях

| Упражнение 05: Исследовать данные о людях |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex05                                                                                                                     |
| Файлы для сдачи                       | `day02_ex05.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Найдите имена всех женщин старше 25 лет и отсортируйте результат по имени. Пример вывода:

| name | 
| ------ | 
| Elvira | 
| ... |

## Глава X
## Упражнение 06 - Любимые пиццы Дениса и Анны

| Упражнение 06: Любимые пиццы Дениса и Анны |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex06                                                                                                                     |
| Файлы для сдачи                       | `day02_ex06.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Найдите все названия пицц (и соответствующие пиццерии из таблицы `menu`), которые заказывали Денис или Анна. Отсортируйте результат по обоим столбцам. Пример вывода:

| pizza_name | pizzeria_name |
| ------ | ------ |
| cheese pizza | Best Pizza |
| cheese pizza | Pizza Hut |
| ... | ... |

## Глава XI
## Упражнение 07 - Самая дешевая пиццерия для Дмитрия

| Упражнение 07: Самая дешевая пиццерия для Дмитрия |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex07                                                                                                                     |
| Файлы для сдачи                       | `day02_ex07.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Найдите название пиццерии, которую посетил Дмитрий 8 января 2022 года и где он мог поесть пиццу дешевле 800 рублей.

## Глава XII
## Упражнение 08 - Продолжаем исследовать данные

| Упражнение 08: Продолжаем исследовать данные |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex08                                                                                                                     |
| Файлы для сдачи                       | `day02_ex08.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |           

Найдите имена всех мужчин из Москвы или Самары, которые заказывали пиццу пепперони или грибную (или обе). Отсортируйте результат по имени в порядке убывания. Пример вывода:

| name | 
| ------ | 
| Dmitriy | 
| ... |

## Глава XIII
## Упражнение 09 - Кто любит сыр и пепперони?

| Упражнение 09: Кто любит сыр и пепперони? |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex09                                                                                                                     |
| Файлы для сдачи                       | `day02_ex09.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Найдите имена всех женщин, которые заказывали и пиццу с сыром, и пиццу с пепперони (в любое время и в любой пиццерии). Отсортируйте результат по имени. Пример вывода:

| name | 
| ------ | 
| Anna | 
| ... |

## Глава XIV
## Упражнение 10 - Найти людей из одного города

| Упражнение 10: Найти людей из одного города |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Каталог для сдачи                     | ex10                                                                                                                     |
| Файлы для сдачи                       | `day02_ex10.sql`                                                                                 |
| **Разрешено**                               |                                                                                                                          |
| Язык                        | ANSI SQL                                                                                              |

Найдите имена людей, которые живут по одному адресу. Отсортируйте результат по имени первого, второго человека и общему адресу. Пример вывода:

| person_name1 | person_name2 | common_address | 
| ------ | ------ | ------ |
| Andrey | Anna | Moscow |
| Denis | Kate | Kazan |
| Elvira | Denis | Kazan |
| ... | ... | ... | 